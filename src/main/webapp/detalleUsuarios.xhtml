<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="es" lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Editar Usuario</title>
    <style type="text/css">
        :root { 
            --primary-color: #2c5aa0;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-bg: #f8f9fa;
            --dark-text: #2c3e50;
        }

        body {
            font-family: Arial, sans-serif;
            background: var(--light-bg);
            margin: 0;
            padding: 0;
            color: var(--dark-text);
        }

        header {
            background: var(--primary-color);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            margin: 0 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header-form {
            background: var(--primary-color);
            color: white;
            padding: 10px 15px;
            font-weight: bold;
        }

        .form-section {
            padding: 20px;
            border-bottom: 1px solid #ddd;
        }

        .form-section h3 {
            margin-top: 0;
            color: var(--secondary-color);
        }

        .form-group {
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
        }

        .form-group label {
            flex: 1 0 200px;
            margin-right: 10px;
            font-weight: bold;
        }

        .form-group input, 
        .form-group select {
            flex: 2 0 250px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .form-actions {
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th, td {
            text-align: left;
            padding: 8px;
        }

        th {
            background: var(--accent-color);
            color: white;
        }
        .message {
          text-align: center;
          margin-bottom: 15px;
          padding: 10px;
          border-radius: 4px;
          font-size: 14px;
          display: none; /* Oculto por defecto */
        }
        .message.error {
          background-color: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
        }
        .message.success {
          background-color: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <header>
        <div>Gestión de Usuarios</div>
        <div>
            Bienvenido, <span id="welcomeUserName"></span> 
            <button class="btn btn-danger" id="logoutBtn">CERRAR SESIÓN</button>
        </div>
    </header>

    <div class="container">
        <div class="header-form">Editar Usuario</div>
        <div id="form-message" class="message"></div>

        <form id="editUserForm" method="post" action="">
            <!-- INFORMACIÓN PERSONAL -->
            <div class="form-section">
                <h3>Información Personal</h3>
                <div class="form-group">
                    <label for="fullname">Nombre completo *</label>
                    <input type="text" id="fullname" name="nombreCompleto" required="required" />
                </div>
                <div class="form-group">
                    <label for="email">Correo electrónico *</label>
                    <input type="email" id="email" name="email" required="required" />
                </div>
                <div class="form-group">
                    <label for="phone">Teléfono *</label>
                    <input type="text" id="phone" name="telefono" required="required" />
                </div>
                <div class="form-group">
                    <label>Fecha de registro</label>
                    <input type="date" id="fechaCreacion" disabled="disabled" />
                </div>
                <div class="form-group">
                    <label>Última sesión</label>
                    <input type="datetime-local" id="ultimaSesion" disabled="disabled" />
                </div>
            </div>

            <!-- ESTADO Y ACCESO -->
            <div class="form-section">
                <h3>Estado y Acceso</h3>
                <div class="form-group">
                    <label for="rolAsignado">Rol asignado *</label>
                    <select id="rolAsignado" name="rolInternoId">
                        <!-- Opciones cargadas por JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="estadoCuenta">Estado de cuenta</label>
                    <select id="estadoCuenta" name="estadoCuentaId">
                        <!-- Opciones cargadas por JS -->
                    </select>
                </div>
            </div>

            <!-- DIRECCIÓN -->
            <div class="form-section" id="direccionSection" style="display:none;">
                <h3>Dirección (solo clientes)</h3>
                <div class="form-group"><label for="calle">Calle</label><input type="text" id="calle" name="calle" /></div>
                <div class="form-group"><label for="numero">Número</label><input type="text" id="numero" name="numero" /></div>
                <div class="form-group"><label for="colonia">Colonia</label><input type="text" id="colonia" name="colonia" /></div>
                <div class="form-group"><label for="ciudad">Ciudad</label><input type="text" id="ciudad" name="ciudad" /></div>
                <div class="form-group"><label for="estado">Estado</label><input type="text" id="estado" name="estado" /></div>
                <div class="form-group"><label for="codigoPostal">Código Postal</label><input type="text" id="codigoPostal" name="codigoPostal" /></div>
            </div>

            <!-- PRIVILEGIOS DEL SISTEMA -->
            <div class="form-section">
                <h3>Privilegios del Sistema</h3>
                <p>La gestión detallada de privilegios por módulo se realizará en una sección dedicada.</p>
                <p>Módulos de acceso general: <span id="accesoModulosSpan"></span></p>
            </div>

            <!-- HISTORIAL DE ACTIVIDAD -->
            <div class="form-section">
                <h3>Historial de Actividad Reciente</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Acción</th>
                            <th>Módulo</th>
                            <th>Detalles</th>
                        </tr>
                    </thead>
                    <tbody id="activityTableBody">
                        <!-- Actividad cargada por JS -->
                    </tbody>
                </table>
            </div>

            <!-- BOTONES -->
            <div class="form-actions">
                <button type="submit" class="btn btn-success">ACTUALIZAR USUARIO</button>
                <button type="button" class="btn btn-secondary" onclick="window.location.href='prueba.xhtml'">CANCELAR</button>
                <button type="button" class="btn btn-danger" id="deactivateUserBtn">DESACTIVAR USUARIO</button>
            </div>
        </form>
    </div>

    <script type="text/javascript">
        const API_BASE_URL = 'http://localhost:8080/modulo-usuarios-javaee/api';
        let currentUserId = null;

        function getToken() {
            return localStorage.getItem('jwt_token');
        }

        function checkAuthAndRedirect() {
            const token = getToken();
            if (!token) {
                window.location.href = 'log3(1).xhtml';
                return false;
            }
            return true;
        }

        function displayWelcomeMessage() {
            const userName = localStorage.getItem('user_email');
            document.getElementById('welcomeUserName').textContent = userName ? userName.split('@')[0] : 'Usuario';
        }

        async function fetchRoles() {
            try {
                const response = await fetch(`${API_BASE_URL}/roles`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                if (!response.ok) throw new Error('Error al cargar roles');
                const roles = await response.json();
                const selectRol = document.getElementById('rolAsignado');
                selectRol.innerHTML = '';
                roles.forEach(rol => {
                    const option = document.createElement('option');
                    option.value = rol.idRol;
                    option.textContent = rol.nombreRol;
                    selectRol.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando roles:', error);
            }
        }

        async function fetchEstadosCuenta() {
            try {
                const response = await fetch(`${API_BASE_URL}/estadoscuenta`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                if (!response.ok) throw new Error('Error al cargar estados de cuenta');
                const estados = await response.json();
                const selectEstado = document.getElementById('estadoCuenta');
                selectEstado.innerHTML = '';
                estados.forEach(estado => {
                    const option = document.createElement('option');
                    option.value = estado.idEstadoCuenta;
                    option.textContent = estado.nombreEstado;
                    selectEstado.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando estados de cuenta:', error);
            }
        }

        async function fetchUserDetails(userId) {
            if (!checkAuthAndRedirect()) return;
            const token = getToken();
            const messageDiv = document.getElementById('form-message');

            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        alert('Su sesión ha expirado o no tiene permisos. Por favor, inicie sesión nuevamente.');
                        localStorage.clear();
                        window.location.href = 'log3(1).xhtml';
                        return;
                    }
                    throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
                }

                const user = await response.json();
                fillFormWithUserData(user);
                // Aquí cargarías fetchUserActivity(user.idUsuario);
                // Y fetchUserPrivileges(user.idUsuario);
                // Si esos endpoints están implementados.

            } catch (error) {
                console.error('Error al cargar detalles del usuario:', error);
                messageDiv.textContent = `Error al cargar detalles: ${error.message}`;
                messageDiv.classList.add('error');
                messageDiv.style.display = 'block';
            }
        }

        function fillFormWithUserData(user) {
            document.getElementById('fullname').value = user.nombreCompleto || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('phone').value = user.telefono || '';
            
            if (user.fechaCreacion) {
                document.getElementById('fechaCreacion').value = new Date(user.fechaCreacion).toISOString().split('T')[0];
            }
            if (user.ultimaSesion) {
                document.getElementById('ultimaSesion').value = new Date(user.ultimaSesion).toISOString().slice(0, 16);
            }

            const rolSelect = document.getElementById('rolAsignado');
            if (user.rolInterno) {
                 for (let i = 0; i < rolSelect.options.length; i++) {
                    if (rolSelect.options[i].textContent === user.rolInterno) {
                        rolSelect.selectedIndex = i;
                        break;
                    }
                }
            } else {
                rolSelect.disabled = true;
            }

            const estadoSelect = document.getElementById('estadoCuenta');
            if (user.estadoCuenta) {
                for (let i = 0; i < estadoSelect.options.length; i++) {
                    if (estadoSelect.options[i].textContent === user.estadoCuenta) {
                        estadoSelect.selectedIndex = i;
                        break;
                    }
                }
            }

            if (user.tipoUsuario === 'Cliente' && user.direccionEnvio) {
                document.getElementById('direccionSection').style.display = 'block';
                try {
                    const address = JSON.parse(user.direccionEnvio);
                    document.getElementById('calle').value = address.calle || '';
                    document.getElementById('numero').value = address.numero || '';
                    document.getElementById('colonia').value = address.colonia || '';
                    document.getElementById('ciudad').value = address.ciudad || '';
                    document.getElementById('estado').value = address.estado || '';
                    document.getElementById('codigoPostal').value = address.codigoPostal || '';
                } catch (e) {
                    console.error('Error parsing direccionEnvio:', e);
                }
            } else {
                document.getElementById('direccionSection').style.display = 'none';
            }

            document.getElementById('accesoModulosSpan').textContent = user.accesoModulos ? user.accesoModulos.join(', ') : 'N/A';
        }

        async function handleSubmit(event) {
            event.preventDefault();
            if (!checkAuthAndRedirect()) return;

            const token = getToken();
            const messageDiv = document.getElementById('form-message');
            messageDiv.style.display = 'none';
            messageDiv.classList.remove('error', 'success');

            const fullname = document.getElementById('fullname').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const rolInternoId = document.getElementById('rolAsignado').value;
            const estadoCuentaId = document.getElementById('estadoCuenta').value;

            let direccionEnvio = null;
            if (document.getElementById('direccionSection').style.display === 'block') {
                const calle = document.getElementById('calle').value;
                const numero = document.getElementById('numero').value;
                const colonia = document.getElementById('colonia').value;
                const ciudad = document.getElementById('ciudad').value;
                const estado = document.getElementById('estado').value;
                const codigoPostal = document.getElementById('codigoPostal').value;
                direccionEnvio = JSON.stringify({ calle, numero, colonia, ciudad, estado, codigoPostal });
            }


            const updateRequest = {
                nombreCompleto: fullname,
                email: email,
                telefono: phone,
                rolInternoId: rolInternoId ? parseInt(rolInternoId) : null,
                estadoCuentaId: parseInt(estadoCuentaId),
                direccionEnvio: direccionEnvio
            };

            try {
                const response = await fetch(`${API_BASE_URL}/users/${currentUserId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateRequest)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Error al actualizar usuario.');
                }

                const updatedUser = await response.json();
                messageDiv.textContent = 'Usuario actualizado exitosamente.';
                messageDiv.classList.add('success');
                messageDiv.style.display = 'block';
                fetchUserDetails(currentUserId);

            } catch (error) {
                console.error('Error al actualizar usuario:', error);
                messageDiv.textContent = `Error: ${error.message}`;
                messageDiv.classList.add('error');
                messageDiv.style.display = 'block';
            }
        }
        
        async function handleDeactivateUser() {
            if (!checkAuthAndRedirect()) return;
            if (!confirm('¿Está seguro de que desea desactivar este usuario? No podrá iniciar sesión.')) {
                return;
            }
            const token = getToken();
            const messageDiv = document.getElementById('form-message');

            try {
                const response = await fetch(`${API_BASE_URL}/users/${currentUserId}/deactivate`, {
                    method: 'PUT', // Cambiado a PUT para desactivación lógica
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 204) {
                    messageDiv.textContent = 'Usuario desactivado exitosamente.';
                    messageDiv.classList.add('success');
                    messageDiv.style.display = 'block';
                    fetchUserDetails(currentUserId);
                } else if (response.status === 401 || response.status === 403) {
                     alert('Su sesión ha expirado o no tiene permisos para realizar esta acción.');
                     localStorage.clear();
                     window.location.href = 'log3(1).xhtml';
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Error al desactivar usuario.');
                }
            } catch (error) {
                console.error('Error al desactivar usuario:', error);
                messageDiv.textContent = `Error al desactivar: ${error.message}`;
                messageDiv.classList.add('error');
                messageDiv.style.display = 'block';
            }
        }


        document.addEventListener('DOMContentLoaded', async function() {
            if (!checkAuthAndRedirect()) return;
            displayWelcomeMessage();

            await fetchRoles();
            await fetchEstadosCuenta();

            const urlParams = new URLSearchParams(window.location.search);
            currentUserId = urlParams.get('id');

            if (currentUserId) {
                fetchUserDetails(currentUserId);
            } else {
                document.getElementById('form-message').textContent = 'ID de usuario no proporcionado.';
                document.getElementById('form-message').classList.add('error');
                document.getElementById('form-message').style.display = 'block';
            }

            document.getElementById('editUserForm').addEventListener('submit', handleSubmit);
            document.getElementById('deactivateUserBtn').addEventListener('click', handleDeactivateUser);
            document.getElementById('logoutBtn').addEventListener("click", async function(){
                if (!checkAuthAndRedirect()) return;
                const token = getToken();
                if (!confirm("¿Estás seguro de que quieres cerrar sesión?")) { return; }
                try {
                    const response = await fetch(`${API_BASE_URL}/auth/logout`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                    });
                    if (response.ok) { console.log("Sesión invalidada en el servidor."); } 
                    else { console.warn("Fallo al invalidar sesión en el servidor, pero se cerrará localmente."); }
                } catch (error) {
                    console.error('Error al intentar cerrar sesión en el servidor:', error);
                } finally {
                    localStorage.clear();
                    window.location.href = 'log3(1).xhtml';
                }
            });
        });
    </script>
</body>
</html>