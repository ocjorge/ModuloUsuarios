<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core"
      xmlns:ui="jakarta.faces.facelets"
      xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
      xml:lang="es"
      lang="es">
    <h:head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Sistema de Usuarios</title>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" type="text/css" />
        <style type="text/css">
            /*<![CDATA[*/
            :root {
                --color-primario: #2c5aa0;
                --color-secundario: #34495e;
                --color-acento: #3498db;
                --color-exito: #27ae60;
                --color-peligro: #e74c3c;
                --color-advertencia: #f39c12;
                --luz-bg: #f8f9fa;
                --texto-oscuro: #2c3e50;
            }

            body {
                margin: 0;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background-color: var(--luz-bg);
                color: var(--texto-oscuro);
            }

            .page {
                display: none;
            }

            .page.active {
                display: block;
            }

            .header {
                background-color: var(--color-primario);
                color: white;
                padding: 15px 30px;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .header h1 {
                margin: 0;
                font-size: 1.5em;
            }

            .header-right {
                display: flex;
                align-items: center;
                gap: 15px;
            }

            .header-right span {
                font-size: 0.95em;
            }

            .header-right .btn-logout {
                background-color: var(--color-peligro);
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 6px;
                font-weight: bold;
                cursor: pointer;
                text-transform: uppercase;
                transition: background-color 0.3s ease;
            }

            .header-right .btn-logout:hover {
                background-color: #c0392b;
            }

            .container-custom {
                max-width: 1200px;
                margin: 30px auto;
                padding: 30px;
                background-color: #ffffff;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }

            h2 {
                color: var(--color-secundario);
                text-align: center;
                margin-bottom: 20px;
            }

            .buttons-nav {
                display: flex;
                gap: 15px;
                margin-bottom: 20px;
            }

            .buttons-nav button {
                padding: 10px 20px;
                border: none;
                border-radius: 6px;
                font-weight: bold;
                text-transform: uppercase;
                cursor: pointer;
                color: white;
                transition: background-color 0.3s ease, transform 0.2s ease;
            }

            .buttons-nav .new-user {
                background-color: var(--color-exito);
            }
            .buttons-nav .new-user:hover {
                background-color: #1e8449;
                transform: translateY(-2px);
            }

            .buttons-nav .filter {
                background-color: var(--color-acento);
            }
            .buttons-nav .filter:hover {
                background-color: #2d80c4;
                transform: translateY(-2px);
            }

            .buttons-nav .tickets {
                background-color: var(--color-secundario);
            }
            .buttons-nav .tickets:hover {
                background-color: #2c4056;
                transform: translateY(-2px);
            }

            table {
                width: 100%;
                border-collapse: collapse;
                background-color: #fff;
                border-radius: 8px;
                overflow: hidden;
            }

            th, td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }

            th {
                background-color: var(--luz-bg);
                font-weight: 600;
                text-transform: uppercase;
                font-size: 0.9em;
            }

            tbody tr:hover {
                background-color: #f1f7fe;
            }

            .actions {
                display: flex;
                gap: 8px;
            }

            .actions button, .actions a {
                padding: 6px 10px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 0.9em;
                color: white;
                text-transform: uppercase;
                text-decoration: none;
                transition: transform 0.2s;
            }

            .actions .edit {
                background-color: var(--color-acento);
            }
            .actions .edit:hover {
                background-color: #2d80c4;
                transform: translateY(-2px);
            }

            .actions .delete {
                background-color: var(--color-peligro);
            }
            .actions .delete:hover {
                background-color: #c0392b;
                transform: translateY(-2px);
            }

            .actions .review {
                background-color: var(--color-secundario);
            }
            .actions .review:hover {
                background-color: #2c4056;
                transform: translateY(-2px);
            }

            .badge {
                padding: 4px 10px;
                border-radius: 12px;
                color: white;
                font-size: 0.85em;
                font-weight: bold;
                text-align: center;
                display: inline-block;
            }
            .activo {
                background-color: var(--color-exito);
            }
            .inactivo {
                background-color: var(--color-peligro);
            }
            .bloqueado {
                background-color: var(--color-secundario);
            }
            .pendiente {
                background-color: var(--color-advertencia);
            }
            .aprobado {
                background-color: var(--color-exito);
            }
            .rechazado {
                background-color: var(--color-peligro);
            }
            .revision {
                background-color: var(--color-acento);
            }

            .auth-box {
                max-width: 450px;
                margin: 100px auto;
                background: white;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                padding: 40px;
            }

            .auth-box h2 {
                text-align: center;
                color: var(--texto-oscuro);
                margin-bottom: 30px;
            }

            .form-control:focus {
                border-color: var(--color-acento);
                box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
            }

            .btn-primary-custom {
                background: var(--color-acento);
                border: none;
                padding: 12px;
                font-weight: bold;
                transition: all 0.3s;
                color: white;
            }

            .btn-primary-custom:hover {
                background: var(--color-primario);
                transform: translateY(-2px);
            }

            .password-toggle {
                cursor: pointer;
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                color: var(--color-secundario);
            }

            .form-group-custom {
                position: relative;
                margin-bottom: 0;
            }

            .form-group-custom input.form-control {
                padding-right: 35px;
            }

            .detail-container {
                max-width: 900px;
                margin: 20px auto;
                background: white;
                border-radius: 6px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                overflow: hidden;
            }

            .header-form {
                background: var(--color-primario);
                color: white;
                padding: 10px 15px;
                font-weight: bold;
            }

            .form-section {
                padding: 20px;
                border-bottom: 1px solid #ddd;
            }

            .form-section h3 {
                margin-top: 0;
                color: var(--color-secundario);
                border-bottom: 2px solid var(--color-acento);
                padding-bottom: 10px;
            }

            .form-group {
                margin-bottom: 15px;
                display: flex;
                flex-wrap: wrap;
                align-items: center;
            }

            .form-group label {
                flex: 1 0 200px;
                margin-right: 10px;
                font-weight: bold;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                flex: 2 0 250px;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
            }

            .form-actions {
                display: flex;
                justify-content: center;
                gap: 10px;
                padding: 20px;
            }

            .btn-success-custom {
                background: var(--color-exito);
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s;
            }

            .btn-success-custom:hover {
                background: #1e8449;
                transform: translateY(-2px);
            }

            .btn-secondary-custom {
                background: var(--color-secundario);
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s;
            }

            .btn-secondary-custom:hover {
                background: #2c3e50;
                transform: translateY(-2px);
            }

            .detail-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
            }

            .detail-table, .detail-table th, .detail-table td {
                border: 1px solid #ddd;
            }

            .detail-table th, .detail-table td {
                text-align: left;
                padding: 8px;
            }

            .detail-table th {
                background: var(--color-acento);
                color: white;
            }

            .messages-container {
                position: fixed;
                top: 70px;
                right: 20px;
                z-index: 10000;
                width: 300px;
            }

            .messages-container .ui-messages-info,
            .messages-container .ui-messages-warn,
            .messages-container .ui-messages-error,
            .messages-container .ui-messages-fatal {
                padding: 10px;
                margin-bottom: 10px;
                border-radius: 5px;
                font-weight: bold;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            }

            .messages-container .ui-messages-info {
                background-color: #e0f2f7;
                border: 1px solid #b2ebf2;
                color: var(--color-acento);
            }

            .messages-container .ui-messages-warn {
                background-color: #fff8e1;
                border: 1px solid #ffe082;
                color: var(--color-advertencia);
            }

            .messages-container .ui-messages-error {
                background-color: #ffebee;
                border: 1px solid #ef9a9a;
                color: var(--color-peligro);
            }

            .btn-close-white {
                filter: invert(1);
            }
            /*]]>*/
        </style>
    </h:head>

    <h:body>
        <!-- Contenedor de mensajes -->
        <div class="messages-container">
            <h:messages globalOnly="false" layout="list" showDetail="true" showSummary="true" styleClass="ui-messages"/>
        </div>

        <h:panelGroup id="mainContent" layout="block">

            <!-- ========================================== -->
            <!-- PGINA DE LOGIN -->
            <!-- ========================================== -->
            <div id="loginPage" class="page #{loginBean.loggedIn ? '' : 'active'}" data-page="loginPage">
                <div class="header">
                    <h1>Sistema de Gesti贸n de Usuarios</h1>
                </div>

                <div class="auth-box">
                    <h2>Iniciar Sesi贸n</h2>
                    <h:form id="loginForm">
                        <div class="mb-3">
                            <h:outputLabel for="loginUsername" value="Correo Electr贸nico" styleClass="form-label" />
                            <h:inputText id="loginUsername"
                                         value="#{loginBean.username}"
                                         styleClass="form-control"
                                         required="true"
                                         requiredMessage="El correo electr贸nico es obligatorio." />
                            <h:message for="loginUsername" errorClass="text-danger" />
                        </div>
                        <div class="mb-3">
                            <h:outputLabel for="loginPassword" value="Contrase帽a" styleClass="form-label" />
                            <div class="form-group-custom">
                                <h:inputSecret id="loginPassword"
                                               value="#{loginBean.password}"
                                               styleClass="form-control"
                                               required="true"
                                               pt:minlength="6"
                                               requiredMessage="La contrase帽a es obligatoria." />
                                <i class="fas fa-eye password-toggle" onclick="togglePassword('loginForm:loginPassword', this)"></i>
                            </div>
                            <h:message for="loginPassword" errorClass="text-danger" />
                        </div>
                        <h:commandButton value="Iniciar Sesi贸n"
                                         styleClass="btn btn-primary-custom w-100 mt-3"
                                         action="#{loginBean.login}">
                            <f:ajax execute="@form" render="@messages mainContent" />
                        </h:commandButton>
                        <div class="text-center mt-3">
                            <small>驴No tienes cuenta? <a href="javascript:void(0);" onclick="showPage('registerPage');">Reg铆strate</a></small>
                        </div>
                    </h:form>
                </div>
            </div>

            <!-- ========================================== -->
            <!-- PGINA DE REGISTRO -->
            <!-- ========================================== -->
            <div id="registerPage" class="page" data-page="registerPage">
                <div class="header">
                    <h1>Registro de Empleados</h1>
                </div>

                <div class="auth-box">
                    <h2>Registrar Empleado</h2>
                    <h:form id="registerForm">
                        <div class="mb-3">
                            <h:outputLabel for="registerEmail" value="Correo electr贸nico" styleClass="form-label" />
                            <h:inputText id="registerEmail"
                                         value="#{loginBean.registerEmail}"
                                         styleClass="form-control"
                                         required="true"
                                         requiredMessage="El correo electr贸nico es obligatorio."
                                         validatorMessage="Formato de correo electr贸nico inv谩lido.">
                                <f:validateRegex pattern="[\w\.-]*[a-zA-Z0-9_]@[\w\.-]*[a-zA-Z0-9]\.[a-zA-Z][a-zA-Z\.]*[a-zA-Z]" />
                            </h:inputText>
                            <h:message for="registerEmail" errorClass="text-danger" />
                        </div>
                        <div class="mb-3">
                            <h:outputLabel for="registerName" value="Nombre completo" styleClass="form-label" />
                            <h:inputText id="registerName"
                                         value="#{loginBean.registerName}"
                                         styleClass="form-control"
                                         required="true"
                                         requiredMessage="El nombre completo es obligatorio." />
                            <h:message for="registerName" errorClass="text-danger" />
                        </div>
                        <div class="mb-3">
                            <h:outputLabel for="registerPhone" value="Tel茅fono" styleClass="form-label" />
                            <h:inputText id="registerPhone"
                                         value="#{loginBean.registerPhone}"
                                         styleClass="form-control"
                                         pt:maxlength="10"
                                         required="true"
                                         requiredMessage="El tel茅fono es obligatorio."
                                         validatorMessage="El tel茅fono debe tener 10 d铆gitos num茅ricos.">
                                <f:validateRegex pattern="^[0-9]{10}$" />
                            </h:inputText>
                            <h:message for="registerPhone" errorClass="text-danger" />
                        </div>
                        <div class="mb-3">
                            <h:outputLabel for="registerPassword" value="Contrase帽a" styleClass="form-label" />
                            <div class="form-group-custom">
                                <h:inputSecret id="registerPassword"
                                               value="#{loginBean.registerPassword}"
                                               styleClass="form-control"
                                               required="true"
                                               pt:minlength="6"
                                               requiredMessage="La contrase帽a es obligatoria." />
                                <i class="fas fa-eye password-toggle" onclick="togglePassword('registerForm:registerPassword', this)"></i>
                            </div>
                            <h:message for="registerPassword" errorClass="text-danger" />
                        </div>
                        <div class="mb-3">
                            <h:outputLabel for="registerConfirmPassword" value="Confirmar Contrase帽a" styleClass="form-label" />
                            <div class="form-group-custom">
                                <h:inputSecret id="registerConfirmPassword"
                                               value="#{loginBean.registerConfirmPassword}"
                                               styleClass="form-control"
                                               required="true"
                                               pt:minlength="6"
                                               requiredMessage="La confirmaci贸n de contrase帽a es obligatoria." />
                                <i class="fas fa-eye password-toggle" onclick="togglePassword('registerForm:registerConfirmPassword', this)"></i>
                            </div>
                            <h:message for="registerConfirmPassword" errorClass="text-danger" />
                        </div>
                        <h:commandButton value="Registrar Empleado"
                                         styleClass="btn btn-primary-custom w-100 mt-3"
                                         action="#{loginBean.register}">
                            <f:ajax execute="@form" render="@messages mainContent" />
                        </h:commandButton>
                        <div class="text-center mt-3">
                            <small>驴Ya tienes cuenta? <a href="javascript:void(0);" onclick="showPage('loginPage');">Inicia sesi贸n</a></small>
                        </div>
                    </h:form>
                </div>
            </div>

            <!-- ========================================== -->
            <!-- PGINA PRINCIPAL - LISTA DE USUARIOS -->
            <!-- ========================================== -->
            <div id="mainPage" class="page #{loginBean.loggedIn ? 'active' : ''}" data-page="mainPage">
                <h:form id="mainPageForm">
                    <div class="header">
                        <h1>Usuarios</h1>
                        <div class="header-right">
                            <span>Bienvenido, <strong>#{loginBean.currentUser.nombreCompleto}</strong></span>
                            <h:commandButton value="Cerrar Sesi贸n"
                                             styleClass="btn-logout"
                                             action="#{loginBean.logout}">
                                <f:ajax execute="@this" render="@messages mainContent" />
                            </h:commandButton>
                        </div>
                    </div>

                    <div class="container-custom">
                        <h2>Lista de Usuarios</h2>

                        <div class="buttons-nav">
                            <button type="button" class="new-user" onclick="showPage('newUserPage'); return false;">
                                + Nuevo Usuario
                            </button>
                            <button type="button" class="tickets" onclick="showPage('ticketsPage'); return false;">
                                <i class="fas fa-ticket-alt"></i> Tickets Pendientes
                            </button>
                            <h:commandButton value=" Refrescar"
                                             styleClass="filter"
                                             action="#{usuarioBean.loadUsuarios}">
                                <f:ajax execute="@this" render="usersTableBody @messages" />
                            </h:commandButton>
                        </div>

                        <h:dataTable value="#{usuarioBean.usuarios}" var="user" styleClass="table" id="usersTableBody">
                            <h:column>
                                <f:facet name="header">Nombre</f:facet>
                                #{user.nombreCompleto}
                            </h:column>
                            <h:column>
                                <f:facet name="header">Correo</f:facet>
                                #{user.correoElectronico}
                            </h:column>
                            <h:column>
                                <f:facet name="header">M贸dulo</f:facet>
                                #{user.idModulo != null ? user.idModulo.nombreModulo : 'N/A'}
                            </h:column>
                            <h:column>
                                <f:facet name="header">Tel茅fono</f:facet>
                                #{user.telefono}
                            </h:column>
                            <h:column>
                                <f:facet name="header">Estado</f:facet>
                                <span class="badge #{user.idEstadoCuenta.nombreEstado.toLowerCase()}">
                                    #{user.idEstadoCuenta.nombreEstado}
                                </span>
                            </h:column>
                            <h:column>
                                <f:facet name="header">Rol</f:facet>
                                #{user.idRol != null ? user.idRol.nombreRol : 'N/A'}
                            </h:column>
                            <h:column>
                                <f:facet name="header">Acciones</f:facet>
                                <div class="actions">
                                    <h:commandLink styleClass="edit"
                                                   value="Editar"
                                                   action="#{usuarioBean.selectUserForEdit(user.idUsuario)}">
                                        <f:ajax execute="@this" render="@none" onevent="function(data){if(data.status=='success')showPage('detailsPage');}" />
                                    </h:commandLink>
                                    <h:commandLink styleClass="delete"
                                                   value="Eliminar"
                                                   onclick="return confirm('驴Est谩 seguro de eliminar a #{user.nombreCompleto}?');"
                                                   action="#{usuarioBean.deleteUsuario(user.idUsuario)}">
                                        <f:ajax execute="@this" render="usersTableBody @messages" />
                                    </h:commandLink>
                                </div>
                            </h:column>
                        </h:dataTable>
                    </div>
                </h:form>
            </div>

            <!-- ========================================== -->
            <!-- PGINA DE EDITAR USUARIO -->
            <!-- ========================================== -->
            <div id="detailsPage" class="page" data-page="detailsPage">
                <h:form id="detailsPageForm">
                    <div class="header">
                        <div>Usuarios</div>
                        <div class="header-right">
                            <span>Bienvenido, <strong>#{loginBean.currentUser.nombreCompleto}</strong></span>
                            <button type="button" class="btn-logout" onclick="showPage('mainPage'); return false;">Volver</button>
                        </div>
                    </div>
                </h:form>

                <div class="detail-container">
                    <div class="header-form">Editar Usuario</div>

                    <h:form id="editUserForm">
                        <h:inputHidden id="editUserId" value="#{usuarioBean.selectedUser.idUsuario}" />

                        <div class="form-section">
                            <h3>Informaci贸n Personal</h3>
                            <div class="form-group">
                                <h:outputLabel for="editUserName" value="Nombre completo *" />
                                <h:inputText id="editUserName"
                                             value="#{usuarioBean.selectedUser.nombreCompleto}"
                                             required="true"
                                             styleClass="form-control" />
                                <h:message for="editUserName" errorClass="text-danger" />
                            </div>
                            <div class="form-group">
                                <h:outputLabel for="editUserEmail" value="Correo electr贸nico *" />
                                <h:inputText id="editUserEmail"
                                             value="#{usuarioBean.selectedUser.correoElectronico}"
                                             required="true"
                                             styleClass="form-control"
                                             validatorMessage="Formato de correo electr贸nico inv谩lido.">
                                    <f:validateRegex pattern="[\w\.-]*[a-zA-Z0-9_]@[\w\.-]*[a-zA-Z0-9]\.[a-zA-Z][a-zA-Z\.]*[a-zA-Z]" />
                                </h:inputText>
                                <h:message for="editUserEmail" errorClass="text-danger" />
                            </div>
                            <div class="form-group">
                                <h:outputLabel for="editUserPhone" value="Tel茅fono *" />
                                <h:inputText id="editUserPhone"
                                             value="#{usuarioBean.selectedUser.telefono}"
                                             pt:maxlength="10"
                                             required="true"
                                             styleClass="form-control"
                                             validatorMessage="El tel茅fono debe tener 10 d铆gitos num茅ricos.">
                                    <f:validateRegex pattern="^[0-9]{10}$" />
                                </h:inputText>
                                <h:message for="editUserPhone" errorClass="text-danger" />
                            </div>
                            <div class="form-group">
                                <h:outputLabel for="editUserRegDate" value="Fecha de registro" />
                                <h:inputText id="editUserRegDate"
                                             value="#{usuarioBean.formattedRegDate}"
                                             readonly="true"
                                             styleClass="form-control" />
                            </div>
                            <div class="form-group">
                                <h:outputLabel for="editUserLastSession" value="ltima sesi贸n" />
                                <h:inputText id="editUserLastSession"
                                             value="#{usuarioBean.formattedLastSession}"
                                             readonly="true"
                                             styleClass="form-control" />
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>Estado y Acceso</h3>
                            <div class="form-group">
                                <h:outputLabel for="editUserRole" value="Rol asignado *" />
                                <h:selectOneMenu id="editUserRole"
                                                 value="#{usuarioBean.newUserRole}"
                                                 required="true"
                                                 styleClass="form-control">
                                    <f:selectItem itemLabel="Seleccione Rol..." itemValue="" noSelectionOption="true" />
                                    <f:selectItems value="#{usuarioBean.rolesInternos}"
                                                   var="rol"
                                                   itemLabel="#{rol.nombreRol}"
                                                   itemValue="#{rol.idRol}" />
                                </h:selectOneMenu>
                                <h:message for="editUserRole" errorClass="text-danger" />
                            </div>
                            <div class="form-group">
                                <h:outputLabel for="editUserStatus" value="Estado de cuenta" />
                                <h:selectOneMenu id="editUserStatus"
                                                 value="#{usuarioBean.newUserStatus}"
                                                 styleClass="form-control">
                                    <f:selectItems value="#{usuarioBean.estadosCuenta}"
                                                   var="estado"
                                                   itemLabel="#{estado.nombreEstado}"
                                                   itemValue="#{estado.idEstadoCuenta}" />
                                </h:selectOneMenu>
                                <h:message for="editUserStatus" errorClass="text-danger" />
                            </div>
                            <div class="form-group">
                                <h:outputLabel for="editUserModule" value="M贸dulo" />
                                <h:selectOneMenu id="editUserModule"
                                                 value="#{usuarioBean.newUserModule}"
                                                 styleClass="form-control">
                                    <f:selectItem itemLabel="Ninguno / Sin M贸dulo" itemValue="" />
                                    <f:selectItems value="#{usuarioBean.modulos}"
                                                   var="modulo"
                                                   itemLabel="#{modulo.nombreModulo}"
                                                   itemValue="#{modulo.idModulo}" />
                                </h:selectOneMenu>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>Direcci贸n (opcional)</h3>
                            <div class="form-group">
                                <h:outputLabel for="editUserAddress" value="Direcci贸n Completa" />
                                <h:inputTextarea id="editUserAddress"
                                                 value="#{usuarioBean.newUserAddress}"
                                                 rows="3"
                                                 styleClass="form-control"
                                                 pt:placeholder="Ej: Av. Reforma 123, Col. Centro, CDMX, CP 00000" />
                                <h:message for="editUserAddress" errorClass="text-danger" />
                            </div>
                        </div>

                        <div class="form-actions">
                            <h:commandButton value="ACTUALIZAR USUARIO"
                                             styleClass="btn-success-custom"
                                             action="#{usuarioBean.updateUsuario}">
                                <f:ajax execute="@form" render="@messages" onevent="function(data){if(data.status=='success')showPage('mainPage');}" />
                            </h:commandButton>
                            <button type="button" class="btn-secondary-custom" onclick="showPage('mainPage'); return false;">
                                CANCELAR
                            </button>
                        </div>
                    </h:form>
                </div>
            </div>

            <!-- ========================================== -->
            <!-- PGINA DE NUEVO USUARIO -->
            <!-- ========================================== -->
            <div id="newUserPage" class="page" data-page="newUserPage">
                <h:form id="newUserPageForm">
                    <div class="header">
                        <h1>Nuevo Usuario</h1>
                        <div class="header-right">
                            <button type="button" class="btn-logout" onclick="showPage('mainPage'); return false;">Volver</button>
                        </div>
                    </div>
                </h:form>

                <div class="detail-container">
                    <div class="header-form">Crear Nuevo Usuario</div>

                    <h:form id="newUserForm">
                        <div class="form-section">
                            <h3>Informaci贸n Personal</h3>

                            <div class="form-group">
                                <h:outputLabel for="newUserTipoUsuario" value="Tipo de Usuario *" />
                                <h:selectOneMenu id="newUserTipoUsuario"
                                                 value="#{usuarioBean.newUserTipoUsuario}"
                                                 required="true"
                                                 styleClass="form-control"
                                                 requiredMessage="El tipo de usuario es obligatorio.">
                                    <f:selectItem itemLabel="Seleccione..." itemValue="" noSelectionOption="true" />
                                    <f:selectItems value="#{usuarioBean.tiposUsuarios}"
                                                   var="tipo"
                                                   itemLabel="#{tipo.nombreTipo}"
                                                   itemValue="#{tipo.idTipoUsuario}" />
                                    <f:ajax event="change" render="internalUserFields" />
                                </h:selectOneMenu>
                                <h:message for="newUserTipoUsuario" errorClass="text-danger" />
                            </div>

                            <div class="form-group">
                                <h:outputLabel for="newUserName" value="Nombre completo *" />
                                <h:inputText id="newUserName"
                                             value="#{usuarioBean.newUserName}"
                                             required="true"
                                             styleClass="form-control"
                                             requiredMessage="El nombre completo es obligatorio."/>
                                <h:message for="newUserName" errorClass="text-danger" />
                            </div>

                            <div class="form-group">
                                <h:outputLabel for="newUserEmail" value="Correo electr贸nico *" />
                                <h:inputText id="newUserEmail"
                                             value="#{usuarioBean.newUserEmail}"
                                             required="true"
                                             styleClass="form-control"
                                             requiredMessage="El correo electr贸nico es obligatorio."
                                             validatorMessage="Formato de correo electr贸nico inv谩lido.">
                                    <f:validateRegex pattern="[\w\.-]*[a-zA-Z0-9_]@[\w\.-]*[a-zA-Z0-9]\.[a-zA-Z][a-zA-Z\.]*[a-zA-Z]" />
                                </h:inputText>
                                <h:message for="newUserEmail" errorClass="text-danger" />
                            </div>

                            <div class="form-group" style="margin-top: 15px; display: flex; align-items: flex-start;">
                                <h:outputLabel for="newUserPassword" value="Contrase帽a *" style="flex: 1 0 200px; margin-right: 10px;" />
                                <div class="form-group-custom" style="flex: 2 0 250px; margin-bottom: 0;">
                                    <h:inputSecret id="newUserPassword"
                                                   value="#{usuarioBean.newUserPassword}"
                                                   styleClass="form-control"
                                                   required="true"
                                                   pt:minlength="6"
                                                   requiredMessage="La contrase帽a es obligatoria."
                                                   style="width: 100%;" />
                                    <i class="fas fa-eye password-toggle" onclick="togglePassword('newUserForm:newUserPassword', this)"></i>
                                </div>
                                <h:message for="newUserPassword" errorClass="text-danger" />
                            </div>

                            <div class="form-group" style="margin-top: 15px; display: flex; align-items: flex-start;">
                                <h:outputLabel for="newUserConfirmPassword" value="Confirmar Contrase帽a *" style="flex: 1 0 200px; margin-right: 10px;" />
                                <div class="form-group-custom" style="flex: 2 0 250px; margin-bottom: 0;">
                                    <h:inputSecret id="newUserConfirmPassword"
                                                   value="#{usuarioBean.newUserConfirmPassword}"
                                                   styleClass="form-control"
                                                   required="true"
                                                   pt:minlength="6"
                                                   requiredMessage="La confirmaci贸n de contrase帽a es obligatoria."
                                                   style="width: 100%;" />
                                    <i class="fas fa-eye password-toggle" onclick="togglePassword('newUserForm:newUserConfirmPassword', this)"></i>
                                </div>
                                <h:message for="newUserConfirmPassword" errorClass="text-danger" />
                            </div>

                            <div class="form-group">
                                <h:outputLabel for="newUserPhone" value="Tel茅fono" />
                                <h:inputText id="newUserPhone"
                                             value="#{usuarioBean.newUserPhone}"
                                             pt:maxlength="10"
                                             styleClass="form-control"
                                             validatorMessage="El tel茅fono debe tener 10 d铆gitos num茅ricos.">
                                    <f:validateRegex pattern="^[0-9]{10}$" />
                                </h:inputText>
                                <h:message for="newUserPhone" errorClass="text-danger" />
                            </div>
                        </div>

                        <h:panelGroup id="internalUserFields"
                                      layout="block"
                                      style="display: #{usuarioBean.newUserTipoUsuario == 1 ? 'block' : 'none'};">
                            <div class="form-section">
                                <h3>Estado y Acceso</h3>

                                <div class="form-group">
                                    <h:outputLabel for="newUserRole" value="Rol asignado *" />
                                    <h:selectOneMenu id="newUserRole"
                                                     value="#{usuarioBean.newUserRole}"
                                                     styleClass="form-control"
                                                     required="#{usuarioBean.newUserTipoUsuario == 1}"
                                                     requiredMessage="El rol es obligatorio para usuarios internos.">
                                        <f:selectItem itemLabel="Seleccione Rol..." itemValue="" noSelectionOption="true" />
                                        <f:selectItems value="#{usuarioBean.rolesInternos}"
                                                       var="rol"
                                                       itemLabel="#{rol.nombreRol}"
                                                       itemValue="#{rol.idRol}" />
                                    </h:selectOneMenu>
                                    <h:message for="newUserRole" errorClass="text-danger" />
                                </div>
                                <div class="form-group">
                                    <h:outputLabel for="newUserModule" value="M贸dulo Asignado" />
                                    <h:selectOneMenu id="newUserModule"
                                                     value="#{usuarioBean.newUserModule}"
                                                     styleClass="form-control">
                                        <f:selectItem itemLabel="Ninguno / Sin M贸dulo" itemValue="" />
                                        <f:selectItems value="#{usuarioBean.modulos}"
                                                       var="modulo"
                                                       itemLabel="#{modulo.nombreModulo}"
                                                       itemValue="#{modulo.idModulo}" />
                                    </h:selectOneMenu>
                                    <h:message for="newUserModule" errorClass="text-danger" />
                                </div>
                            </div>
                        </h:panelGroup>

                        <div class="form-section">
                            <div class="form-group">
                                <h:outputLabel for="newUserStatus" value="Estado de cuenta *" />
                                <h:selectOneMenu id="newUserStatus"
                                                 value="#{usuarioBean.newUserStatus}"
                                                 required="true"
                                                 styleClass="form-control"
                                                 requiredMessage="El estado de cuenta es obligatorio.">
                                    <f:selectItems value="#{usuarioBean.estadosCuenta}"
                                                   var="estado"
                                                   itemLabel="#{estado.nombreEstado}"
                                                   itemValue="#{estado.idEstadoCuenta}" />
                                </h:selectOneMenu>
                                <h:message for="newUserStatus" errorClass="text-danger" />
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>Direcci贸n (opcional)</h3>
                            <div class="form-group">
                                <h:outputLabel for="newUserAddress" value="Direcci贸n Completa" />
                                <h:inputTextarea id="newUserAddress"
                                                 value="#{usuarioBean.newUserAddress}"
                                                 rows="3"
                                                 styleClass="form-control"
                                                 pt:placeholder="Ej: Av. Reforma 123, Col. Centro, CDMX, CP 00000" />
                                <h:message for="newUserAddress" errorClass="text-danger" />
                            </div>
                        </div>

                        <div class="form-actions">
                            <h:commandButton value="GUARDAR USUARIO"
                                             styleClass="btn-success-custom"
                                             action="#{usuarioBean.createUsuario}">
                                <f:ajax execute="@form" render="@messages" onevent="function(data){if(data.status=='success'){showPage('mainPage');}}" />
                            </h:commandButton>
                            <button type="button" class="btn-secondary-custom" onclick="showPage('mainPage'); return false;">
                                CANCELAR
                            </button>
                        </div>
                    </h:form>
                </div>
            </div>

            <!-- ========================================== -->
            <!-- PGINA DE TICKETS -->
            <!-- ========================================== -->
            <div id="ticketsPage" class="page" data-page="ticketsPage">
                <h:form id="ticketsPageForm">
                    <div class="header">
                        <h1>Tickets de Revisi贸n</h1>
                        <div class="header-right">
                            <span>Bienvenido, <strong>#{loginBean.currentUser.nombreCompleto}</strong></span>
                            <button type="button" class="btn-logout" onclick="showPage('mainPage'); return false;">
                                Volver a Usuarios
                            </button>
                        </div>
                    </div>

                    <div class="container-custom">
                        <h2>Listado de Solicitudes Pendientes</h2>

                        <div class="buttons-nav">
                            <h:commandButton value="Todos"
                                             styleClass="filter"
                                             action="#{ticketBean.filterTicketsByState('Todos')}">
                                <f:ajax execute="@this" render="ticketsTableBody @messages" />
                            </h:commandButton>
                            <h:commandButton value="Pendientes"
                                             styleClass="filter pendiente"
                                             action="#{ticketBean.filterTicketsByState('Pendiente')}">
                                <f:ajax execute="@this" render="ticketsTableBody @messages" />
                            </h:commandButton>
                            <h:commandButton value="En Revisi贸n"
                                             styleClass="filter revision"
                                             action="#{ticketBean.filterTicketsByState('En Revisi贸n')}">
                                <f:ajax execute="@this" render="ticketsTableBody @messages" />
                            </h:commandButton>
                        </div>

                        <h:dataTable value="#{ticketBean.tickets}" var="ticket" styleClass="table" id="ticketsTableBody">
                            <h:column>
                                <f:facet name="header">ID Ticket</f:facet>
                                #{ticket.idTicket}
                            </h:column>
                            <h:column>
                                <f:facet name="header">Tipo de Cambio</f:facet>
                                #{ticket.idTipoCambio.nombreCambio}
                            </h:column>
                            <h:column>
                                <f:facet name="header">M贸dulo</f:facet>
                                #{ticket.idModulo.nombreModulo}
                            </h:column>
                            <h:column>
                                <f:facet name="header">Fecha Solicitud</f:facet>
                                <h:outputText value="#{ticket.fechaSolicitud}">
                                    <f:convertDateTime pattern="yyyy-MM-dd" />
                                </h:outputText>
                            </h:column>
                            <h:column>
                                <f:facet name="header">Estado</f:facet>
                                <span class="badge #{ticket.idEstado.nombreEstado.toLowerCase().replace(' ', '-')}">
                                    #{ticket.idEstado.nombreEstado}
                                </span>
                            </h:column>
                            <h:column>
                                <f:facet name="header">Usuario Solicitante</f:facet>
                                #{ticket.idUsuario.nombreCompleto} (#{ticket.idUsuario.correoElectronico})
                            </h:column>
                            <h:column>
                                <f:facet name="header">Acciones</f:facet>
                                <div class="actions">
                                    <h:commandButton styleClass="review"
                                                     value="Revisar"
                                                     action="#{ticketBean.selectTicketForReview}">
                                        <f:param name="ticketId" value="#{ticket.idTicket}" />
                                        <f:ajax execute="@this" render="@none" onevent="function(data){if(data.status=='success')showPage('reviewTicketPage');}" />
                                    </h:commandButton>
                                </div>
                            </h:column>
                        </h:dataTable>
                    </div>
                </h:form>
            </div>
        </h:panelGroup>

        <!-- ========================================== -->
        <!-- SCRIPTS -->
        <!-- ========================================== -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

        <h:outputScript>
        //<![CDATA[

        // ===== Navegaci贸n entre p谩ginas =====
        function showPage(pageId) {
            console.log('=== showPage llamado con:', pageId);
            
            // Ocultar todas las p谩ginas
            const allPages = document.querySelectorAll('.page');
            console.log('Total de p谩ginas encontradas:', allPages.length);
            
            allPages.forEach(function(page) {
                page.classList.remove('active');
                console.log('Ocultando p谩gina:', page.id);
            });
            
            // Mostrar la p谩gina objetivo
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                console.log(' P谩gina activada:', pageId);
            } else {
                console.error(' P谩gina no encontrada:', pageId);
            }
        }

        // ===== Toggle de contrase帽as =====
        function togglePassword(inputId, icon) {
            const input = document.getElementById(inputId);
            if (!input) {
                console.log('Input no encontrado:', inputId);
                return;
            }

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // ===== Inicializaci贸n =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DOM CARGADO ===');
            
            // Mostrar todas las p谩ginas disponibles
            const allPages = document.querySelectorAll('.page');
            console.log('P谩ginas encontradas:', allPages.length);
            allPages.forEach(page => {
                console.log(' - ID:', page.id, 'Visible:', page.classList.contains('active'));
            });
            
            // Verificar si hay p谩gina activa
            const activePage = document.querySelector('.page.active');
            if (activePage) {
                console.log('P谩gina activa inicial:', activePage.id);
            } else {
                console.log('No hay p谩gina activa, mostrando login por defecto');
                // Forzar mostrar login si no hay p谩gina activa
                const loginPage = document.getElementById('loginPage');
                if (loginPage) {
                    loginPage.classList.add('active');
                }
            }
        });

        // ===== Manejo de campos de usuario interno =====
        function toggleInternalFields() {
            const tipoUsuarioSelect = document.getElementById('newUserForm:newUserTipoUsuario');
            const internalFieldsDiv = document.getElementById('newUserForm:internalUserFields');

            if (!tipoUsuarioSelect || !internalFieldsDiv) return;

            const isInternal = tipoUsuarioSelect.value === '1';
            internalFieldsDiv.style.display = isInternal ? 'block' : 'none';

            if (!isInternal) {
                const rolSelect = document.getElementById('newUserForm:newUserRole');
                const moduleSelect = document.getElementById('newUserForm:newUserModule');
                if (rolSelect) rolSelect.value = '';
                if (moduleSelect) moduleSelect.value = '';
            }
        }

        // Inicializar campos al cargar
        document.addEventListener('DOMContentLoaded', toggleInternalFields);

        //]]>
        </h:outputScript>
    </h:body>
</html>