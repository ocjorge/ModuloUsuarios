<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

<h:head>
    <title>Usuario</title>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" />

    <style>
        body {
            background-color:#f0f2f5;
        }
        .topbar {
            background:#275fa7;
            color:white;
            padding:12px 24px;
            font-size:20px;
            font-weight:bold;
        }
        .btn-volver {
            background:#c0392b !important;
            color:white !important;
            padding:6px 14px;
            border-radius:6px;
        }
        .seccion-titulo {
            font-size:20px;
            margin-bottom:10px;
            padding-bottom:6px;
            border-bottom:2px solid #275fa7;
        }
        .help-text {
            font-size: 0.80rem;
            color: #555;
        }
    </style>
</h:head>

<h:body>

    <!-- BARRA SUPERIOR -->
    <nav class="navbar navbar-dark" style="background-color:#225ca8;">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                #{usuarioBean.edicion ? 'Editar Usuario' : 'Nuevo Usuario'}
            </span>

            <div class="d-flex align-items-center">
                <h:form>
                    <h:commandLink value="Volver"
                                   action="usuarios.xhtml?faces-redirect=true"
                                   styleClass="btn btn-light me-2"/>

                    <h:commandLink value="Dashboard"
                                   action="dashboard.xhtml?faces-redirect=true"
                                   styleClass="btn btn-outline-light"/>
                </h:form>
            </div>
        </div>
    </nav>

    <!-- METADATA (carga usuario + verifica sesión) -->
    <f:metadata>
        <f:viewParam name="id" value="#{usuarioBean.idParam}" />
        <f:viewAction action="#{usuarioBean.verificarSesion}" />
        <f:viewAction action="#{usuarioBean.initForm}" />
    </f:metadata>

    <!-- CONTENIDO -->
    <div class="container py-4" style="max-width:900px;">

        <h:form prependId="false">

            <h:messages globalOnly="true"
                        layout="table"
                        styleClass="w-100 mb-3"
                        style="list-style:none; padding:0; margin:0;"
                        infoClass="alert alert-success d-block"
                        errorClass="alert alert-danger d-block" />

            <!-- SECCIÓN -->
            <div class="seccion-titulo">Información del Usuario</div>

            <div class="row g-3">

                <!-- TIPO USUARIO -->
                <div class="col-md-4">
                    <label class="form-label">Tipo de Usuario *</label>
                    <h:selectOneMenu id="comboTipo"
                                     value="#{usuarioBean.tipoUsuarioId}"
                                     styleClass="form-control">
                        <f:selectItems value="#{usuarioBean.tiposUsuario}" var="t"
                                       itemLabel="#{t.nombre}" itemValue="#{t.id}" />
                    </h:selectOneMenu>
                    <small class="help-text">
                        1 = Interno, 2 = Externo (proveedor/banco), 3 = Cliente final
                    </small>
                    <h:message for="comboTipo" styleClass="text-danger small mt-1"/>
                </div>

                <!-- NOMBRE -->
                <div class="col-md-8">
                    <label class="form-label">Nombre completo *</label>
                    <h:inputText id="txtNombre"
                                 value="#{usuarioBean.usuarioSeleccionado.nombreCompleto}"
                                 required="true"
                                 requiredMessage="El nombre es obligatorio"
                                 styleClass="form-control"/>
                    <h:message for="txtNombre" styleClass="text-danger small mt-1"/>
                </div>

                <!-- CORREO -->
                <div class="col-md-6">
                    <label class="form-label">Correo electrónico *</label>
                    <h:inputText id="txtCorreo"
                                 value="#{usuarioBean.usuarioSeleccionado.correoElectronico}"
                                 required="true"
                                 requiredMessage="El correo es obligatorio"
                                 styleClass="form-control"/>
                    <h:message for="txtCorreo" styleClass="text-danger small mt-1"/>
                </div>

                <!-- TELÉFONO -->
                <div class="col-md-6">
                    <label class="form-label">Teléfono</label>
                    <h:inputText value="#{usuarioBean.usuarioSeleccionado.telefono}"
                                 styleClass="form-control"/>
                </div>

                <!-- ROL INTERNO -->
                <div class="col-md-6">
                    <label class="form-label">
                        Rol Interno #{usuarioBean.interno ? '*' : '(no aplica)'}
                    </label>
                    <h:selectOneMenu value="#{usuarioBean.rolId}"
                                     styleClass="form-control"
                                     disabled="#{!usuarioBean.interno}">
                        <f:selectItem itemValue="#{null}" itemLabel="-- Sin rol --" />
                        <f:selectItems value="#{usuarioBean.rolesInternos}" var="r"
                                       itemLabel="#{r.nombre}" itemValue="#{r.id}" />
                    </h:selectOneMenu>
                    <small class="help-text">
                        Solo usuarios internos (tipo 1) deben tener rol.
                    </small>
                </div>

                <!-- ESTADO CUENTA -->
                <div class="col-md-6">
                    <label class="form-label">Estado *</label>
                    <h:selectOneMenu value="#{usuarioBean.estadoCuentaId}"
                                     styleClass="form-control">
                        <f:selectItems value="#{usuarioBean.estadosCuenta}" var="e"
                                       itemLabel="#{e.nombre}" itemValue="#{e.id}" />
                    </h:selectOneMenu>
                </div>

                <!-- MÓDULO -->
                <div class="col-md-6">
                    <label class="form-label">
                        Módulo
                        <small class="help-text d-block">
                            Interno: elige módulo; Externo: PRV o BCO; Cliente final: CLI (fijo).
                        </small>
                    </label>
                    <h:selectOneMenu value="#{usuarioBean.moduloId}"
                                     styleClass="form-control"
                                     disabled="#{usuarioBean.clienteFinal}">
                        <f:selectItem itemValue="#{null}" itemLabel="Seleccione módulo"/>
                        <f:selectItems value="#{usuarioBean.modulos}" var="m"
                                       itemLabel="#{m.nombre}" itemValue="#{m.id}" />
                    </h:selectOneMenu>
                </div>

                <!-- EMPRESA (solo proveedores externos PRV, visualmente solo para tipo 2) -->
                <div class="col-md-6">
                    <label class="form-label">
                        Empresa (externo proveedor)
                    </label>
                    <h:selectOneMenu value="#{usuarioBean.empresaCodigo}"
                                     styleClass="form-control"
                                     disabled="#{!usuarioBean.externo}">
                        <f:selectItem itemValue="#{null}" itemLabel="-- Sin empresa / No aplica --"/>
                        <f:selectItem itemValue="FV"  itemLabel="FrutoVerde (FV)"/>
                        <f:selectItem itemValue="KNS" itemLabel="Mueblería KNS (KNS)"/>
                        <f:selectItem itemValue="GRN" itemLabel="Granelia (GRN)"/>
                        <f:selectItem itemValue="CRE" itemLabel="CarnesRE (CRE)"/>
                    </h:selectOneMenu>
                    <small class="help-text">
                        Obligatorio solo cuando Tipo = Externo (2) y módulo = PRV.
                    </small>
                </div>

                <!-- DIRECCIÓN -->
                <div class="col-md-12">
                    <label class="form-label">Dirección</label>
                    <h:inputTextarea value="#{usuarioBean.usuarioSeleccionado.direccion}"
                                     styleClass="form-control" rows="2"/>
                </div>

                <!-- USERNAME -->
                <div class="col-md-6">
                    <label class="form-label">Username *</label>
                    <h:inputText id="txtUsername"
                                 value="#{usuarioBean.usuarioSeleccionado.username}"
                                 required="true"
                                 requiredMessage="El usuario es obligatorio"
                                 styleClass="form-control"
                                 maxlength="40"/>
                    <small class="help-text">
                        Interno: sin prefijo. Externo proveedor: se guardará como FV-usuario, KNS-usuario, etc.
                        Cliente final: se guardará como CLI-usuario (en alta).
                    </small>
                    <h:message for="txtUsername" styleClass="text-danger small mt-1"/>
                </div>

                <!-- CONTRASEÑA -->
                <div class="col-md-6">
                    <label class="form-label">
                        Contraseña #{usuarioBean.edicion ? "(opcional)" : "*"}
                    </label>
                    <h:inputSecret id="txtPassword"
                                   value="#{usuarioBean.passwordPlano}"
                                   required="#{!usuarioBean.edicion}"
                                   requiredMessage="La contraseña es obligatoria para nuevos usuarios"
                                   styleClass="form-control"/>
                    <h:message for="txtPassword" styleClass="text-danger small mt-1"/>
                </div>

            </div>

            <!-- BOTONES -->
            <div class="mt-4 d-flex gap-2">
                <h:commandButton value="Guardar"
                                 actionListener="#{usuarioBean.guardar}"
                                 styleClass="btn btn-primary" />

                <h:link outcome="usuarios.xhtml"
                        value="Cancelar"
                        styleClass="btn btn-secondary"/>
            </div>

        </h:form>
    </div>

</h:body>
</html>
