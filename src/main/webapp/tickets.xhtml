<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

<h:head>
    <title>Tickets Pendientes</title>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" />
</h:head>

<h:body style="background-color:#f0f2f5;">

<f:metadata>
    <f:viewAction action="#{ticketBean.verificarSesion}" />
</f:metadata>

<nav class="navbar navbar-dark" style="background-color:#225ca8;">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">Tickets Pendientes</span>
        <div class="d-flex align-items-center">
            <span class="text-white me-3">
                #{ticketBean.sessionManager.usuarioActual.nombreCompleto}
            </span>
            <h:form>
                <h:commandLink value="Dashboard"
                               action="dashboard.xhtml?faces-redirect=true"
                               styleClass="btn btn-light me-2"/>
                <h:commandLink value="Cerrar Sesión"
                               actionListener="#{ticketBean.sessionManager.cerrarSesion}"
                               styleClass="btn btn-danger"/>
            </h:form>
        </div>
    </div>
</nav>

<div class="container py-4">

    <!-- FILTROS -->
    <h:form prependId="false" styleClass="card p-3 shadow-sm mb-3">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Módulo</label>
                <h:selectOneMenu value="#{ticketBean.moduloFiltro}" styleClass="form-select">
                    <f:selectItem itemValue="#{null}" itemLabel="Todos"/>
                    <f:selectItems value="#{ticketBean.modulos}" var="m"
                                   itemValue="#{m.id}" itemLabel="#{m.nombre}"/>
                </h:selectOneMenu>
            </div>

            <div class="col-md-4">
                <label class="form-label">Estado</label>
                <h:selectOneMenu value="#{ticketBean.estadoFiltro}" styleClass="form-select">
                    <f:selectItem itemValue="#{null}" itemLabel="Todos"/>
                    <f:selectItems value="#{ticketBean.estadosTicket}" var="e"
                                   itemValue="#{e.id}" itemLabel="#{e.nombre}"/>
                </h:selectOneMenu>
            </div>

            <div class="col-md-4">
                <label class="form-label">Tipo de cambio</label>
                <h:selectOneMenu value="#{ticketBean.tipoCambioFiltro}" styleClass="form-select">
                    <f:selectItem itemValue="#{null}" itemLabel="Todos"/>
                    <f:selectItems value="#{ticketBean.tiposCambio}" var="tc"
                                   itemValue="#{tc.id}" itemLabel="#{tc.nombre}"/>
                </h:selectOneMenu>
            </div>

            <div class="col-md-12 d-flex gap-2">
                <h:commandButton value="Filtrar" action="#{ticketBean.filtrar}"
                                 styleClass="btn btn-primary"/>
                <h:commandButton value="Limpiar" action="#{ticketBean.limpiarFiltros}"
                                 styleClass="btn btn-secondary" immediate="true"/>
            </div>
        </div>
    </h:form>

    <h:messages globalOnly="true"/>

    <!-- TABLA -->
    <div class="card shadow-sm">
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead class="table-primary">
                <tr>
                    <th>Fecha</th>
                    <th>Usuario</th>
                    <th>Módulo</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th style="width:240px;">Acciones</th>
                </tr>
                </thead>

                <tbody>
                <ui:repeat value="#{ticketBean.tickets}" var="t">
                    <tr>
                        <td>#{t.fechaSolicitud}</td>
                        <td>#{t.usuario.nombreCompleto}</td>
                        <td>#{t.modulo.nombre}</td>
                        <td>#{t.tipoCambio.nombre}</td>
                        <td>#{t.estado.nombre}</td>

                        <td class="d-flex gap-2">
                            <h:form>
                                <h:commandLink value="Detalle" action="#{ticketBean.verDetalle(t.id)}"
                                               styleClass="btn btn-sm btn-outline-primary"/>

                                <h:commandButton value="Aprobar" actionListener="#{ticketBean.aprobar(t.id)}"
                                                 styleClass="btn btn-sm btn-success"
                                                 onclick="return confirm('¿Aprobar ticket?');"/>

                                <h:commandButton value="Rechazar" actionListener="#{ticketBean.rechazar(t.id)}"
                                                 styleClass="btn btn-sm btn-danger"
                                                 onclick="return confirm('¿Rechazar ticket?');"/>
                            </h:form>
                        </td>
                    </tr>
                </ui:repeat>
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- FOOTER -->
<nav class="navbar navbar-expand-lg navbar-dark fixed-bottom"
     style="background-color:#87CEEB; border-top:2px solid #5aa7c8;">
    <div class="container-fluid justify-content-center">
        <span class="navbar-text fw-bold" style="color:#003366;">
            Desarrollado por Brisa Hernández Reyes · Jorge Ortiz Ceballos ·
            Luis Carlos Romero Corral — Módulo Usuarios —
            Materia: Programación Web · Agosto–Diciembre 2025
        </span>
    </div>
</nav>

</h:body>
</html>
