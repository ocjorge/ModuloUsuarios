<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core"
      xmlns:pt="http://xmlns.jcp.org/jsf/passthrough">
    <h:head>
        <title>Editar Usuario - Sistema de Usuarios</title>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <style type="text/css">
            :root {
                --color-primario: #2c5aa0;
                --color-secundario: #34495e;
                --color-acento: #3498db;
                --color-exito: #27ae60;
                --luz-bg: #f8f9fa;
                --texto-oscuro: #2c3e50;
            }
            body {
                margin: 0;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background-color: var(--luz-bg);
                color: var(--texto-oscuro);
            }
            .header {
                background-color: var(--color-primario);
                color: white;
                padding: 15px 30px;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            .detail-container {
                max-width: 800px;
                margin: 20px auto;
                background: white;
                border-radius: 6px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                overflow: hidden;
            }
            .header-form {
                background: var(--color-primario);
                color: white;
                padding: 10px 15px;
                font-weight: bold;
            }
            .form-section {
                padding: 20px;
                border-bottom: 1px solid #ddd;
            }
            .form-section h3 {
                margin-top: 0;
                color: var(--color-secundario);
                border-bottom: 2px solid var(--color-acento);
                padding-bottom: 10px;
            }
            .form-actions {
                display: flex;
                justify-content: center;
                gap: 10px;
                padding: 20px;
            }
            .btn-success-custom {
                background: var(--color-exito);
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                font-weight: bold;
                cursor: pointer;
            }
            .btn-secondary-custom {
                background: var(--color-secundario);
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                font-weight: bold;
                cursor: pointer;
                text-decoration: none;
            }
        </style>
    </h:head>
    <h:body>
        <f:metadata>
            <f:viewParam name="id" value="#{usuarioBean.selectedUserIdStr}" />
            <f:event type="preRenderView" listener="#{usuarioBean.loadUserForEdit}" />
        </f:metadata>

        <div class="header">
            <h1>Editar Usuario</h1>
            <div class="header-right">
                <h:button value="← Volver" outcome="usuarios" styleClass="btn-secondary-custom" />
            </div>
        </div>

        <div class="messages-container" style="max-width: 800px; margin: 20px auto;">
            <h:messages globalOnly="false" layout="list" showDetail="true" showSummary="true" 
                       infoClass="alert alert-info" warnClass="alert alert-warning" 
                       errorClass="alert alert-danger" fatalClass="alert alert-danger"/>
        </div>

        <div class="detail-container">
            <div class="header-form">
                Editar Usuario: 
                <h:outputText value="#{usuarioBean.selectedUser.nombreCompleto}" 
                            rendered="#{usuarioBean.selectedUser != null}" />
                <h:outputText value="Cargando..." 
                            rendered="#{usuarioBean.selectedUser == null}" />
            </div>

            <h:form id="editUserForm" rendered="#{usuarioBean.selectedUser != null}">
                <h:inputHidden id="editUserId" value="#{usuarioBean.selectedUser.idUsuario}" />

                <div class="form-section">
                    <h3>Información Personal</h3>
                    <div class="mb-3">
                        <h:outputLabel for="editUserName" value="Nombre completo *" styleClass="form-label" />
                        <h:inputText id="editUserName"
                                     value="#{usuarioBean.selectedUser.nombreCompleto}"
                                     styleClass="form-control"
                                     required="true"
                                     requiredMessage="El nombre completo es obligatorio." />
                        <h:message for="editUserName" styleClass="text-danger" />
                    </div>
                    <div class="mb-3">
                        <h:outputLabel for="editUserEmail" value="Correo electrónico *" styleClass="form-label" />
                        <h:inputText id="editUserEmail"
                                     value="#{usuarioBean.selectedUser.correoElectronico}"
                                     styleClass="form-control"
                                     required="true"
                                     requiredMessage="El correo electrónico es obligatorio."
                                     validatorMessage="Formato de correo electrónico inválido.">
                            <f:validateRegex pattern="[\w\.-]*[a-zA-Z0-9_]@[\w\.-]*[a-zA-Z0-9]\.[a-zA-Z][a-zA-Z\.]*[a-zA-Z]" />
                        </h:inputText>
                        <h:message for="editUserEmail" styleClass="text-danger" />
                    </div>
                    <div class="mb-3">
                        <h:outputLabel for="editUserPhone" value="Teléfono *" styleClass="form-label" />
                        <h:inputText id="editUserPhone"
                                     value="#{usuarioBean.selectedUser.telefono}"
                                     styleClass="form-control"
                                     pt:maxlength="10"
                                     required="true"
                                     requiredMessage="El teléfono es obligatorio."
                                     validatorMessage="El teléfono debe tener 10 dígitos numéricos.">
                            <f:validateRegex pattern="^[0-9]{10}$" />
                        </h:inputText>
                        <h:message for="editUserPhone" styleClass="text-danger" />
                    </div>
                    <div class="mb-3">
                        <h:outputLabel for="editUserRegDate" value="Fecha de registro" styleClass="form-label" />
                        <h:inputText id="editUserRegDate"
                                     value="#{usuarioBean.formattedRegDate}"
                                     styleClass="form-control"
                                     readonly="true" />
                    </div>
                    <div class="mb-3">
                        <h:outputLabel for="editUserLastSession" value="Última sesión" styleClass="form-label" />
                        <h:inputText id="editUserLastSession"
                                     value="#{usuarioBean.formattedLastSession}"
                                     styleClass="form-control"
                                     readonly="true" />
                    </div>
                </div>

                <div class="form-section">
                    <h3>Estado y Acceso</h3>
                    <div class="mb-3">
                        <h:outputLabel for="editUserRole" value="Rol asignado" styleClass="form-label" />
                        <h:selectOneMenu id="editUserRole"
                                         value="#{usuarioBean.newUserRole}"
                                         styleClass="form-control">
                            <f:selectItem itemLabel="Sin rol asignado" itemValue="" />
                            <f:selectItems value="#{usuarioBean.rolesInternos}"
                                           var="rol"
                                           itemLabel="#{rol.nombreRol}"
                                           itemValue="#{rol.idRol}" />
                        </h:selectOneMenu>
                        <h:message for="editUserRole" styleClass="text-danger" />
                    </div>
                    <div class="mb-3">
                        <h:outputLabel for="editUserStatus" value="Estado de cuenta *" styleClass="form-label" />
                        <h:selectOneMenu id="editUserStatus"
                                         value="#{usuarioBean.newUserStatus}"
                                         styleClass="form-control"
                                         required="true"
                                         requiredMessage="El estado de cuenta es obligatorio.">
                            <f:selectItems value="#{usuarioBean.estadosCuenta}"
                                           var="estado"
                                           itemLabel="#{estado.nombreEstado}"
                                           itemValue="#{estado.idEstadoCuenta}" />
                        </h:selectOneMenu>
                        <h:message for="editUserStatus" styleClass="text-danger" />
                    </div>
                    <div class="mb-3">
                        <h:outputLabel for="editUserModule" value="Módulo" styleClass="form-label" />
                        <h:selectOneMenu id="editUserModule"
                                         value="#{usuarioBean.newUserModule}"
                                         styleClass="form-control">
                            <f:selectItem itemLabel="Ninguno / Sin Módulo" itemValue="" />
                            <f:selectItems value="#{usuarioBean.modulos}"
                                           var="modulo"
                                           itemLabel="#{modulo.nombreModulo}"
                                           itemValue="#{modulo.idModulo}" />
                        </h:selectOneMenu>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Dirección</h3>
                    <div class="mb-3">
                        <h:outputLabel for="editUserAddress" value="Dirección Completa" styleClass="form-label" />
                        <h:inputTextarea id="editUserAddress"
                                         value="#{usuarioBean.newUserAddress}"
                                         rows="3"
                                         styleClass="form-control"
                                         pt:placeholder="Ej: Av. Reforma 123, Col. Centro, CDMX, CP 00000" />
                        <h:message for="editUserAddress" styleClass="text-danger" />
                    </div>
                </div>

                <div class="form-actions">
                    <h:commandButton value="ACTUALIZAR USUARIO"
                                     styleClass="btn-success-custom"
                                     action="#{usuarioBean.updateUsuario}">
                        <f:ajax execute="@form" render="@messages" />
                    </h:commandButton>
                    <h:button value="CANCELAR" outcome="usuarios" styleClass="btn-secondary-custom" />
                </div>
            </h:form>

            <div class="form-section" rendered="#{usuarioBean.selectedUser == null}">
                <div class="alert alert-danger">
                    <h4>Usuario no encontrado</h4>
                    <p>El usuario que intentas editar no existe o no se pudo cargar.</p>
                    <h:button value="Volver a la lista" outcome="usuarios" styleClass="btn btn-primary" />
                </div>
            </div>
        </div>
    </h:body>
</html>